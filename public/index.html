<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Video Messenger - Yahoo Mail</title>
    <link rel="stylesheet" href="css/styles.css?v=6">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/studio.css">
    <link rel="stylesheet" href="css/studio-fabric.css?v=5">
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal hidden">
        <div class="login-content">
            <h2>Join Video Chat</h2>
            <p class="login-subtitle">Enter the password to connect with others</p>
            <div class="login-form">
                <input type="text" id="usernameInput" placeholder="Your name (optional)" class="login-input">
                <input type="password" id="passwordInput" placeholder="Password: Yahoo" class="login-input">
                <button id="loginBtn" class="btn-login">Join</button>
            </div>
        </div>
    </div>

    <!-- Remote Video Preview - Top Left -->
    <div class="remote-video-frame hidden" id="remoteVideoFrame">
        <div class="video-frame remote">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="frame-overlay"></div>
            <div class="video-label">Remote User</div>
        </div>
    </div>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status">
        <div class="status-dot disconnected"></div>
        <span class="status-text">Not Connected</span>
    </div>

    <!-- Top Navigation - Centered -->
    <div class="top-nav-container">
        <button id="emailToggleBtn" class="top-nav-btn active" title="Oasis Email">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <span>Oasis Email</span>
        </button>
        <button id="videoToggleBtn" class="top-nav-btn" title="Video Chat">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg>
            <span>Video</span>
        </button>
        <button id="studioToggleBtn" class="top-nav-btn" title="Open Studio Canvas">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z"></path>
            </svg>
            <span>Studio</span>
        </button>
    </div>

    <!-- Draggable UI Container -->
    <div class="draggable-ui-container hidden" id="draggableUI">
        <!-- Drag Handle -->
        <div class="drag-handle" id="dragHandle" title="Drag to move frame">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3"/>
            </svg>
        </div>
        <!-- Circular Video Preview - Hidden by default, shown in Video mode -->
        <div class="video-preview-dock hidden" id="videoPreviewDock">
            <div class="video-frame">
                <video id="preview" autoplay muted playsinline></video>
                <canvas id="effectsCanvas"></canvas>
                <canvas id="stickersCanvas"></canvas>
                <div class="frame-overlay"></div>
                <div class="video-label">You</div>
                <div id="recording-indicator" class="recording-indicator hidden">
                    <span class="recording-dot"></span>
                </div>
            </div>
            <button id="zoomBtn" class="btn-zoom" title="Zoom In/Out">
                <svg id="zoomIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                    <line x1="11" y1="8" x2="11" y2="14"></line>
                    <line x1="8" y1="11" x2="14" y2="11"></line>
                </svg>
            </button>
            <button id="minimizeBtn" class="btn-minimize" title="Minimize UI">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>

        <!-- Effects Controls -->
        <div class="effects-dock">
        <button id="glassesBtn" class="btn-icon btn-effect" title="Purple Glasses">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 12s3-6 10-6 10 6 10 6-3 6-10 6-10-6-10-6z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
            <span class="btn-label">Glasses</span>
        </button>
        <button id="sparklesBtn" class="btn-icon btn-effect" title="Sparkles">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z"></path>
                <path d="M19 14L19.5 16.5L22 17L19.5 17.5L19 20L18.5 17.5L16 17L18.5 16.5L19 14Z"></path>
            </svg>
            <span class="btn-label">Sparkles</span>
        </button>
        <button id="backgroundBtn" class="btn-icon btn-effect" title="Background Removal">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span class="btn-label">Background</span>
        </button>
        <button id="frameBtn" class="btn-icon btn-effect" title="Custom Frames">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                <rect x="7" y="7" width="10" height="10" rx="1"></rect>
            </svg>
            <span class="btn-label">Frames</span>
        </button>
        <button id="particlesBtn" class="btn-icon btn-effect active" title="Confetti & Particles">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="6" cy="6" r="2"></circle>
                <circle cx="18" cy="6" r="2"></circle>
                <circle cx="6" cy="18" r="2"></circle>
                <circle cx="18" cy="18" r="2"></circle>
                <rect x="11" y="4" width="2" height="3" transform="rotate(45 12 5.5)"></rect>
                <rect x="17" y="10" width="2" height="3" transform="rotate(135 18 11.5)"></rect>
                <rect x="11" y="17" width="2" height="3" transform="rotate(225 12 18.5)"></rect>
                <rect x="4" y="11" width="2" height="3" transform="rotate(315 5 12.5)"></rect>
                <polygon points="12,9 13,11 15,12 13,13 12,15 11,13 9,12 11,11"></polygon>
            </svg>
            <span class="btn-label">Confetti</span>
        </button>
        <button id="stickerBtn" class="btn-icon btn-effect" title="Add Stickers">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="9" cy="9" r="1.5"></circle>
                <circle cx="15" cy="9" r="1.5"></circle>
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" fill="none" stroke="currentColor" stroke-width="1.5"></path>
                <path d="M8.5 14.5c1 1.5 2.5 2 3.5 2s2.5-.5 3.5-2"></path>
            </svg>
            <span class="btn-label">Stickers</span>
        </button>
        <button id="premiumBtn" class="btn-icon btn-effect btn-premium" title="Premium Effects">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z"></path>
                <path d="M19 14L19.5 16.5L22 17L19.5 17.5L19 20L18.5 17.5L16 17L18.5 16.5L19 14Z"></path>
            </svg>
            <span class="btn-label">Premium</span>
            <span class="lock-badge">üîê</span>
        </button>
    </div>

        <!-- Background Color Picker -->
        <div id="bgColorPicker" class="bg-color-picker hidden">
            <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;" title="Purple"></div>
            <div class="color-option" data-color="#3b82f6" style="background: #3b82f6;" title="Blue"></div>
            <div class="color-option" data-color="#10b981" style="background: #10b981;" title="Green"></div>
            <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;" title="Orange"></div>
            <div class="color-option" data-color="#ef4444" style="background: #ef4444;" title="Red"></div>
            <div class="color-option" data-color="#ec4899" style="background: #ec4899;" title="Pink"></div>
        </div>

        <!-- Position Calibrator -->
        <div id="positionCalibrator" class="position-calibrator hidden">
            <button id="moveUpBtn" class="btn-icon btn-calibrate" title="Move Up">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            </button>
            <span id="offsetDisplay" class="offset-display">0</span>
            <button id="moveDownBtn" class="btn-icon btn-calibrate" title="Move Down">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
        </div>

        <!-- Glasses Picker -->
        <div id="glassesPicker" class="glasses-picker hidden">
            <div class="glasses-option" data-glasses="0" title="Red Glasses">
                <img src="vtube/Red.png" alt="Red Glasses">
            </div>
            <div class="glasses-option" data-glasses="1" title="Deer Antlers 1">
                <img src="vtube/Deer 1.png" alt="Deer Antlers 1">
            </div>
            <div class="glasses-option" data-glasses="2" title="Deer Antlers 2">
                <img src="vtube/Deer 2.png" alt="Deer Antlers 2">
            </div>
            <div class="glasses-option" data-glasses="3" title="Santa Hat 1">
                <img src="vtube/SantaHat1.png" alt="Santa Hat 1">
            </div>
            <div class="glasses-option" data-glasses="4" title="Santa Hat 2">
                <img src="vtube/SantaHat2.png" alt="Santa Hat 2">
            </div>
            <div class="glasses-option" data-glasses="5" title="Dwarf Hat">
                <img src="vtube/DwarfHat.png" alt="Dwarf Hat">
            </div>
            <div class="glasses-option" data-glasses="6" title="Xmas Hat 1">
                <img src="vtube/xmass hat 1.png" alt="Xmas Hat 1">
            </div>
            <div class="glasses-option" data-glasses="7" title="Xmas Hat 2">
                <img src="vtube/xmass hat 2.png" alt="Xmas Hat 2">
            </div>
            <div class="glasses-option" data-glasses="8" title="Xmas Hat 3">
                <img src="vtube/xmass hat 3.png" alt="Xmas Hat 3">
            </div>
            <div class="glasses-option" data-glasses="9" title="Xmas Hat 4">
                <img src="vtube/xmass hat 4.png" alt="Xmas Hat 4">
            </div>
            <div class="glasses-option" data-glasses="10" title="Tree 1">
                <img src="vtube/Tree1.png" alt="Tree 1">
            </div>
            <div class="glasses-option" data-glasses="11" title="Tree 2">
                <img src="vtube/Tree2.png" alt="Tree 2">
            </div>
            <div class="glasses-option" data-glasses="12" title="Snowman">
                <img src="vtube/Snowman.png" alt="Snowman">
            </div>
            <div class="glasses-option" data-glasses="13" title="Gingerbread">
                <img src="vtube/GingerBread.png" alt="Gingerbread">
            </div>
        </div>

        <!-- Frame Picker -->
        <div id="framePicker" class="frame-picker hidden">
            <div class="frame-option active" data-frame="frame.png" title="Original Frame">
                <div class="frame-preview">
                    <div class="preview-circle">
                        <span>üñºÔ∏è</span>
                    </div>
                </div>
                <span class="frame-label">Original</span>
            </div>
            <div class="frame-option" data-frame="doodle" title="Hand-Drawn Doodles">
                <div class="frame-preview">
                    <div class="preview-circle doodle-style">
                        <span>‚úèÔ∏è</span>
                    </div>
                </div>
                <span class="frame-label">Doodle</span>
            </div>
            <div class="frame-option" data-frame="washi" title="Washi Tape">
                <div class="frame-preview">
                    <div class="preview-circle washi-style">
                        <span>üìé</span>
                    </div>
                </div>
                <span class="frame-label">Washi</span>
            </div>
            <div class="frame-option" data-frame="polaroid" title="Polaroid Style">
                <div class="frame-preview">
                    <div class="preview-circle polaroid-style">
                        <span>üì∑</span>
                    </div>
                </div>
                <span class="frame-label">Polaroid</span>
            </div>
            <div class="frame-option" data-frame="stickers" title="Sticker Burst">
                <div class="frame-preview">
                    <div class="preview-circle stickers-style">
                        <span>‚≠ê</span>
                    </div>
                </div>
                <span class="frame-label">Stickers</span>
            </div>
            <div class="frame-option" data-frame="winter" title="Winter Wonderland">
                <div class="frame-preview">
                    <div class="preview-circle winter-style">
                        <span>‚ùÑÔ∏è</span>
                    </div>
                </div>
                <span class="frame-label">Winter</span>
            </div>
            <div class="frame-option locked" data-frame="spring" title="üîí Coming Soon!">
                <div class="frame-preview">
                    <div class="preview-circle spring-style">
                        <span>üîí</span>
                    </div>
                </div>
                <span class="frame-label">Locked</span>
            </div>
        </div>

        <!-- Sticker Picker -->
        <div id="stickerPicker" class="sticker-picker hidden"></div>

        <!-- Premium Picker -->
        <div id="premiumPicker" class="premium-picker hidden">
            <div class="premium-header">
                <span class="premium-title">‚ú® Premium</span>
                <span class="premium-badge">PREVIEW</span>
            </div>
            <div class="premium-preview">
                <img src="css/premium.png" alt="Premium Effect Preview">
            </div>
            <div class="premium-footer">
                <span class="premium-cta">Coming soon with Yahoo Mail Premium</span>
            </div>
        </div>

        <!-- Minimal Controls -->
        <div class="controls-dock">
        <button id="joinVideoBtn" class="btn-icon btn-join" title="Join Video Chat">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </button>
        <span id="timer" class="timer">00:00</span>
        <div class="control-buttons">
            <button id="startBtn" class="btn-icon btn-record" title="Start Recording">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="8"></circle>
                </svg>
            </button>
            <button id="stopBtn" class="btn-icon btn-stop" disabled title="Stop Recording">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="7" y="7" width="10" height="10" rx="2"></rect>
                </svg>
            </button>
        </div>
        </div>
    </div>

    <!-- Studio Mode Container -->
    <div id="studioContainer" class="studio-container hidden">
        <!-- Studio Canvas -->
        <canvas id="studioCanvas"></canvas>

        <!-- Drop Hint -->
        <div class="studio-drop-hint">Drop image here</div>

        <!-- Studio Top Bar (Connection Status only) -->
        <div class="studio-top-bar">
            <div class="studio-connection-status" id="studioConnectionStatus">
                <div class="status-dot disconnected"></div>
                <span class="status-text">Not Connected</span>
            </div>
        </div>

        <!-- Zoom Controls -->
        <div class="studio-zoom-controls">
            <button id="zoomInBtn" class="studio-zoom-btn" title="Zoom In">+</button>
            <span id="zoomIndicator">100%</span>
            <button id="zoomOutBtn" class="studio-zoom-btn" title="Zoom Out">‚àí</button>
            <button id="resetViewBtn" class="studio-zoom-btn" title="Reset View" style="font-size: 14px;">‚ü≤</button>
        </div>

        <!-- Clear Canvas Button -->
        <button id="clearCanvasBtn" class="studio-clear-btn" title="Clear Canvas">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Clear
        </button>

        <!-- Studio Video Preview (Picture-in-Picture style) - Hidden by default -->
        <div id="studioVideoPreview" class="studio-video-preview hidden">
            <!-- Connect Button (above video) -->
            <button id="studioConnectBtn" class="studio-pip-connect-btn" title="Connect to Video Chat">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </button>
            <!-- Drag Handle -->
            <div class="drag-handle" id="studioVideoDragHandle">
                <div class="drag-handle-dots">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
            </div>
            <div class="studio-video-frame">
                <video id="studioPreviewVideo" autoplay muted playsinline></video>
                <div class="studio-video-label">You</div>
            </div>
            <div class="studio-video-controls">
                <span id="studioTimer" class="studio-timer">00:00</span>
                <button id="studioSnapshotBtn" class="studio-snapshot-btn" title="Take Snapshot">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </button>
                <button id="studioRecordBtn" class="studio-record-btn" title="Start Recording">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="12" r="8"></circle>
                    </svg>
                </button>
                <button id="studioStopBtn" class="studio-stop-btn" disabled title="Stop Recording">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="7" y="7" width="10" height="10" rx="2"></rect>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Connected Users Indicator -->
        <div id="studioUsersIndicator" class="studio-users-indicator hidden">
            <div class="users-avatars" id="usersAvatars"></div>
            <span class="users-count" id="usersCount">1 in studio</span>
        </div>

        <!-- Instructions Panel -->
        <div class="studio-instructions">
            <h4>Studio Controls</h4>
            <ul>
                <li><span class="instruction-key">Scroll</span> to zoom in/out</li>
                <li><span class="instruction-key">Drag</span> canvas to pan</li>
                <li><span class="instruction-key">Ctrl+V</span> to paste images</li>
                <li><span class="instruction-key">Del</span> to remove selected</li>
                <li>Drag clipart from drawer below</li>
            </ul>
        </div>

        <!-- Clipart Drawer -->
        <div id="studioDrawer" class="studio-drawer">
            <div id="drawerToggle" class="drawer-handle">
                <div class="drawer-handle-bar"></div>
            </div>
            <div class="drawer-header">
                <div>
                    <div class="drawer-title">Clipart Library</div>
                    <div class="drawer-subtitle">Drag items onto canvas or click to add</div>
                </div>
            </div>
            <div id="clipartGrid" class="clipart-grid">
                <!-- Clipart items populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- NEW: Fabric.js Studio Container -->
    <div id="studioFabricContainer" class="studio-fabric-container hidden">
        <!-- Left Toolbar -->
        <div class="studio-left-toolbar">
            <!-- Primary Create Button -->
            <button class="studio-create-btn" id="studioMainCreateBtn" title="Create">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>

            <!-- Tool Buttons -->
            <button class="studio-tool-btn active" data-tool="select" title="Select">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                </svg>
                <span class="tool-label">Select</span>
            </button>

            <button class="studio-tool-btn" data-tool="draw" data-panel="draw" title="Draw">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                </svg>
                <span class="tool-label">Draw</span>
            </button>

            <button class="studio-tool-btn" data-tool="text" data-panel="text" title="Text">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 7 4 4 20 4 20 7"/>
                    <line x1="9" y1="20" x2="15" y2="20"/>
                    <line x1="12" y1="4" x2="12" y2="20"/>
                </svg>
                <span class="tool-label">Text</span>
            </button>

            <button class="studio-tool-btn" data-panel="stickers" title="Stickers">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
                <span class="tool-label">Stickers</span>
            </button>

            <button class="studio-tool-btn" data-panel="gifs" title="GIFs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                    <line x1="7" y1="2" x2="7" y2="22"/>
                    <line x1="17" y1="2" x2="17" y2="22"/>
                    <line x1="2" y1="12" x2="22" y2="12"/>
                    <line x1="2" y1="7" x2="7" y2="7"/>
                    <line x1="2" y1="17" x2="7" y2="17"/>
                    <line x1="17" y1="17" x2="22" y2="17"/>
                    <line x1="17" y1="7" x2="22" y2="7"/>
                </svg>
                <span class="tool-label">GIFs</span>
            </button>

            <button class="studio-tool-btn" data-panel="clipart" title="Clipart">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span class="tool-label">Clipart</span>
            </button>

            <button class="studio-tool-btn" id="studioImageBtn" title="Upload Image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <span class="tool-label">Images</span>
            </button>

            <button class="studio-tool-btn" id="studioCameraBtn" title="Add Camera Selfie">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                    <circle cx="12" cy="13" r="4"/>
                </svg>
                <span class="tool-label">Selfie</span>
            </button>

            <button class="studio-tool-btn studio-premium-btn" id="studioPremiumBtn" data-panel="premium" title="Premium Effects">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z"/>
                    <path d="M19 14L19.5 16.5L22 17L19.5 17.5L19 20L18.5 17.5L16 17L18.5 16.5L19 14Z"/>
                </svg>
                <span class="tool-label">Premium</span>
                <span class="studio-lock-badge">üîê</span>
            </button>

            <div class="studio-toolbar-divider"></div>

            <button class="studio-tool-btn" id="studioUndoBtn" title="Undo (Ctrl+Z)" disabled>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"/>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
            </button>

            <button class="studio-tool-btn" id="studioRedoBtn" title="Redo (Ctrl+Shift+Z)" disabled>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
            </button>

            <div class="studio-toolbar-spacer"></div>

            <!-- Save and Send Button at bottom -->
            <button class="studio-tool-btn studio-send-btn" id="studioSendEmailBtn" title="Save and Send">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                <span class="tool-label">Save & Send</span>
            </button>
        </div>

        <!-- Secondary Panel (slides out) -->
        <div id="studioSecondaryPanel" class="studio-secondary-panel">
            <div id="studioPanelContent" class="studio-panel-content">
                <!-- Panel content rendered by JS -->
            </div>
        </div>

        <!-- Canvas Container -->
        <div id="studioCanvasContainer" class="studio-canvas-container">
            <canvas id="studioFabricCanvas"></canvas>

            <!-- Cursor Overlay (for multiplayer) -->
            <div class="studio-cursor-overlay" id="studioCursorOverlay"></div>
        </div>

        <!-- Floating Create Button -->
        <div class="studio-floating-create">
            <div id="studioQuickMenu" class="studio-quick-menu">
                <button class="studio-quick-menu-item" data-action="draw">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    </svg>
                    Start Drawing
                </button>
                <button class="studio-quick-menu-item" data-action="text">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 7 4 4 20 4 20 7"/>
                        <line x1="12" y1="4" x2="12" y2="20"/>
                    </svg>
                    Add Text
                </button>
                <button class="studio-quick-menu-item" data-action="sticker">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    </svg>
                    Add Sticker
                </button>
                <button class="studio-quick-menu-item" data-action="gif">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="2" width="20" height="20" rx="2"/>
                    </svg>
                    Add GIF
                </button>
                <button class="studio-quick-menu-item" data-action="image">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                    </svg>
                    Upload Image
                </button>
            </div>
            <button id="studioFloatingCreateBtn" class="studio-floating-create-btn">
                <span>‚ú®</span>
                Create
            </button>
        </div>

        <!-- Zoom Controls -->
        <div class="studio-zoom-controls">
            <button id="studioZoomOut" class="studio-zoom-btn" title="Zoom Out">‚àí</button>
            <span id="studioZoomDisplay">100%</span>
            <button id="studioZoomIn" class="studio-zoom-btn" title="Zoom In">+</button>
        </div>
    </div>

    <!-- Video Envelope Component -->
    <div id="videoEnvelope" class="video-envelope hidden" role="dialog" aria-label="Video message preview">
        <div class="envelope-container">
            <!-- Envelope Flap -->
            <div class="envelope-flap"></div>

            <!-- Video Preview in Envelope -->
            <div class="envelope-body">
                <video id="playback" playsinline aria-label="Recorded video preview"></video>
            </div>

            <!-- Recipient Selector -->
            <div id="recipientContainer" class="envelope-recipient hidden">
                <select id="recipientSelect" class="envelope-select" aria-label="Select recipient">
                    <option value="">To: Select recipient...</option>
                </select>
            </div>

            <!-- Send Button (Flying Envelope Style) -->
            <button id="sendEnvelopeBtn" class="btn-send-envelope" title="Send Video Message" aria-label="Send video message">
                <svg class="envelope-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span class="send-text">Send</span>
            </button>

            <!-- Action Buttons -->
            <div class="envelope-actions" role="group" aria-label="Video controls">
                <button id="playEnvelopeBtn" class="btn-envelope-action" title="Play video" aria-label="Play video">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                </button>
                <a id="downloadBtn" class="btn-envelope-action" download="video-message.webm" title="Download video" aria-label="Download video">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </a>
                <button id="discardBtn" class="btn-envelope-action btn-discard" title="Discard video" aria-label="Discard video">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Incoming Message Modal -->
    <div id="incomingMessageModal" class="playback-modal hidden">
        <div class="playback-content">
            <h3>Video Message from <span id="messageSender"></span></h3>
            <div class="playback-video-container">
                <video id="incomingMessageVideo" controls autoplay playsinline></video>
            </div>
            <div class="playback-controls">
                <button id="closeMessageBtn" class="btn-icon btn-discard" title="Close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Status messages -->
    <div id="status" class="status-toast hidden"></div>

    <!-- Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Fallback to CDN if local Socket.io fails to load
        if (typeof io === 'undefined') {
            document.write('<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"><\/script>');
        }
    </script>

    <!-- MediaPipe Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>

    <!-- Menu Manager - Load first to handle all menu interactions -->
    <script src="js/menu-manager.js?v=1"></script>

    <script src="js/connection.js?v=17"></script>
    <script src="js/effects.js?v=17"></script>
    <script src="js/particles.js?v=17"></script>
    <script src="js/stickers.js?v=17"></script>
    <script src="js/achievements.js?v=17"></script>
    <script src="js/recorder.js?v=17"></script>
    <script src="js/frames.js?v=17"></script>
    <script src="js/studio.js?v=1"></script>

    <!-- Fabric.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <!-- New Fabric.js Studio -->
    <script src="js/studio-fabric.js?v=6"></script>
    <script src="js/studio-panels.js?v=5"></script>
    <script src="js/studio-tools.js?v=2"></script>

    <!-- Layout Validator Agent - Ensures perfect circular button arrangement -->
    <script src="js/layout-validator.js?v=1"></script>

    <!-- Initialize navigation and mode switching -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const emailToggleBtn = document.getElementById('emailToggleBtn');
            const videoToggleBtn = document.getElementById('videoToggleBtn');
            const studioToggleBtn = document.getElementById('studioToggleBtn');
            const oldStudioContainer = document.getElementById('studioContainer');
            const newStudioContainer = document.getElementById('studioFabricContainer');
            const draggableUI = document.getElementById('draggableUI');
            const videoPreviewDock = document.getElementById('videoPreviewDock');
            const studioVideoPreview = document.getElementById('studioVideoPreview');

            // Mode state
            let currentMode = 'email'; // 'email', 'video', 'studio'

            function setActiveButton(activeBtn) {
                [emailToggleBtn, videoToggleBtn, studioToggleBtn].forEach(btn => {
                    if (btn) btn.classList.remove('active');
                });
                if (activeBtn) activeBtn.classList.add('active');
            }

            function switchToEmail() {
                currentMode = 'email';
                setActiveButton(emailToggleBtn);

                // Hide ALL video UI
                if (draggableUI) draggableUI.classList.add('hidden');
                if (videoPreviewDock) videoPreviewDock.classList.add('hidden');
                if (studioVideoPreview) studioVideoPreview.classList.add('hidden');

                // Hide studio
                if (newStudioContainer) newStudioContainer.classList.add('hidden');
                if (oldStudioContainer) oldStudioContainer.classList.add('hidden');
                if (window.studioFabric) window.studioFabric.deactivate();
            }

            function switchToVideo() {
                currentMode = 'video';
                setActiveButton(videoToggleBtn);

                // Show video UI in upper right, make draggable
                if (draggableUI) draggableUI.classList.remove('hidden');
                if (videoPreviewDock) {
                    videoPreviewDock.classList.remove('hidden');
                    // Position in upper right
                    videoPreviewDock.style.position = 'fixed';
                    videoPreviewDock.style.top = '80px';
                    videoPreviewDock.style.right = '24px';
                    videoPreviewDock.style.left = 'auto';
                    videoPreviewDock.style.bottom = 'auto';
                }
                // Hide old studio video preview
                if (studioVideoPreview) studioVideoPreview.classList.add('hidden');

                // Initialize camera when entering Video mode
                if (window.videoRecorder && window.videoRecorder.initializeCamera) {
                    window.videoRecorder.initializeCamera();
                }

                // Hide studio
                if (newStudioContainer) newStudioContainer.classList.add('hidden');
                if (oldStudioContainer) oldStudioContainer.classList.add('hidden');
                if (window.studioFabric) window.studioFabric.deactivate();
            }

            function switchToStudio() {
                currentMode = 'studio';
                setActiveButton(studioToggleBtn);

                // Hide ALL video UI completely
                if (draggableUI) draggableUI.classList.add('hidden');
                if (videoPreviewDock) videoPreviewDock.classList.add('hidden');
                if (studioVideoPreview) studioVideoPreview.classList.add('hidden');

                // Show studio
                if (newStudioContainer) newStudioContainer.classList.remove('hidden');
                if (oldStudioContainer) oldStudioContainer.classList.add('hidden');
                if (window.studioFabric) window.studioFabric.activate();
            }

            // Button click handlers
            if (emailToggleBtn) {
                emailToggleBtn.addEventListener('click', switchToEmail, true);
            }

            if (videoToggleBtn) {
                videoToggleBtn.addEventListener('click', switchToVideo, true);
            }

            if (studioToggleBtn) {
                studioToggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    switchToStudio();
                }, true);
            }

            // Make video preview draggable anywhere on the circle
            if (videoPreviewDock) {
                let isDragging = false;
                let dragOffsetX = 0;
                let dragOffsetY = 0;

                videoPreviewDock.addEventListener('mousedown', function(e) {
                    if (currentMode !== 'video') return;
                    isDragging = true;
                    const rect = videoPreviewDock.getBoundingClientRect();
                    dragOffsetX = e.clientX - rect.left;
                    dragOffsetY = e.clientY - rect.top;
                    videoPreviewDock.style.cursor = 'grabbing';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    const x = e.clientX - dragOffsetX;
                    const y = e.clientY - dragOffsetY;
                    videoPreviewDock.style.left = x + 'px';
                    videoPreviewDock.style.top = y + 'px';
                    videoPreviewDock.style.right = 'auto';
                    videoPreviewDock.style.bottom = 'auto';
                });

                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        videoPreviewDock.style.cursor = 'grab';
                    }
                });

                // Touch support for mobile
                videoPreviewDock.addEventListener('touchstart', function(e) {
                    if (currentMode !== 'video') return;
                    isDragging = true;
                    const touch = e.touches[0];
                    const rect = videoPreviewDock.getBoundingClientRect();
                    dragOffsetX = touch.clientX - rect.left;
                    dragOffsetY = touch.clientY - rect.top;
                }, { passive: true });

                document.addEventListener('touchmove', function(e) {
                    if (!isDragging) return;
                    const touch = e.touches[0];
                    const x = touch.clientX - dragOffsetX;
                    const y = touch.clientY - dragOffsetY;
                    videoPreviewDock.style.left = x + 'px';
                    videoPreviewDock.style.top = y + 'px';
                    videoPreviewDock.style.right = 'auto';
                    videoPreviewDock.style.bottom = 'auto';
                }, { passive: true });

                document.addEventListener('touchend', function() {
                    isDragging = false;
                });
            }

            // Start in email mode (default)
            switchToEmail();
        });
    </script>
</body>
</html>
